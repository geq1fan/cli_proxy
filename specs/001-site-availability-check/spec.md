# Feature Specification: Site Availability Check Module

**Feature Branch**: `001-site-availability-check`
**Created**: 2025-12-07
**Status**: Draft
**Input**: User description: "在页面首页新增已有站点的可用性检测功能模块"

## Clarifications

### Session 2025-12-07

- Q: Claude Code和Codex站点的连通性检测应该用什么技术方法? → A: 发送最小API请求(如模型列表查询)
- Q: 首次加载首页时,系统是否应该自动触发一次站点检测? → A: 首次加载自动触发一次检测,后续仅手动
- Q: 站点检测失败时,应该如何细分失败类型来帮助用户判断问题原因? → A: 详细显示所有HTTP状态码和错误信息
- Q: 历史检测记录应该保存在哪里? → A: 浏览器localStorage,保留最近10-20条记录
- Q: 当用户配置了大量站点(如50个)时,同时并发检测的最大数量应该是多少? → A: 限制并发数为5个,按批次检测

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看所有站点健康状态 (Priority: P1)

作为CLI代理用户,我想在首页快速查看所有配置站点的可用性状态,以便及时发现服务不可用的站点并切换配置。

**Why this priority**: 这是核心监控需求,用户需要在打开首页时立即看到所有站点的健康状态,避免使用不可用的站点导致请求失败。

**Independent Test**: 可以通过访问首页并查看站点列表完整测试。用户应该能看到每个站点的URL、状态指示器(绿色=可用/红色=不可用)和响应时间。

**Acceptance Scenarios**:

1. **Given** 用户已配置了2个Claude站点(anyrouter, 88code), **When** 打开首页, **Then** 可用性检测模块显示这2个站点的当前状态
2. **Given** 某个站点正常可用, **When** 系统检测该站点, **Then** 显示绿色状态指示器和响应时间(如"235ms")
3. **Given** 某个站点不可用, **When** 系统检测该站点, **Then** 显示红色状态指示器和错误信息(如"连接超时")

---

### User Story 2 - 手动刷新站点状态 (Priority: P2)

作为CLI代理用户,我想手动触发站点可用性检测,以便在怀疑某个站点状态变化时立即获取最新状态。

**Why this priority**: 用户可能需要在修复站点配置后立即验证,而不是等待自动刷新。

**Independent Test**: 可以通过点击刷新按钮并观察状态更新来测试。不依赖自动检测功能。

**Acceptance Scenarios**:

1. **Given** 用户在查看站点状态, **When** 点击"刷新"按钮, **Then** 系统重新检测所有站点并更新状态显示
2. **Given** 某个站点从不可用变为可用, **When** 用户手动刷新, **Then** 该站点状态指示器从红色变为绿色
3. **Given** 正在进行检测, **When** 用户再次点击刷新, **Then** 系统提示"正在检测中"并忽略重复请求

---

### User Story 3 - 查看历史检测记录 (Priority: P3)

作为CLI代理用户,我想查看站点的历史可用性记录,以便分析站点的稳定性趋势。

**Why this priority**: 这是增强功能,帮助用户了解站点的长期稳定性,但不是基础监控的必要功能。

**Independent Test**: 可以通过点击站点详情并查看历史记录来测试。

**Acceptance Scenarios**:

1. **Given** 某个站点已有10次检测记录, **When** 用户点击该站点查看详情, **Then** 显示最近10次检测的时间、状态和响应时间
2. **Given** 用户查看历史记录, **When** 发现站点在某个时间段频繁失败, **Then** 可以据此决定是否排除该站点

---

### Edge Cases

- 如果用户没有配置任何站点(claude.json和codex.json都为空),模块显示"暂无站点配置"提示
- 如果检测请求超时(>10秒),标记为不可用并显示"超时错误:请求超过10秒未响应"及详细的网络错误类型
- 如果站点返回非2xx状态码,标记为不可用并显示完整的HTTP状态码和服务器返回的错误消息(如"401 Unauthorized: Invalid API key"或"500 Internal Server Error: Service temporarily unavailable")
- 如果发生网络连接失败,显示详细的网络错误类型(如"DNS解析失败"、"连接被拒绝"、"TLS握手失败")
- 如果站点URL格式错误,跳过检测并显示"配置错误:无效的URL格式"
- 如果用户在检测进行中关闭页面,取消未完成的请求
- 如果同时配置了大量站点(>10个),检测应按批次进行,避免阻塞UI

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须读取所有已配置的Claude和Codex站点信息
- **FR-002**: 系统必须通过发送最小API请求(如模型列表查询)检测每个站点的可用性,验证完整的API链路可用性
- **FR-003**: 系统必须为每个站点显示当前状态(可用/不可用)、站点地址和响应时间
- **FR-004**: 系统必须在首次加载首页时自动触发一次站点可用性检测
- **FR-005**: 用户必须能够手动触发站点可用性检测
- **FR-006**: 系统必须支持检测超时机制,超时后标记站点为不可用
- **FR-007**: 系统必须在后台检测站点,不阻塞页面加载和用户交互,使用批次检测机制限制并发数为5个
- **FR-008**: 系统必须在检测失败时详细显示HTTP状态码和完整错误信息,包括网络错误、超时错误和服务器返回的错误消息
- **FR-009**: 系统必须使用浏览器localStorage记录每个站点最近10-20次的检测历史供用户查看
- **FR-010**: 系统必须提供清晰的视觉指示器区分可用和不可用状态
- **FR-011**: 系统必须处理站点配置为空的情况,显示友好提示

### Key Entities

- **Site**: 代表一个API站点配置
  - 属性: 站点名称、站点地址、服务类型(Claude/Codex)
  - 来源: 系统配置

- **AvailabilityRecord**: 代表一次可用性检测结果
  - 属性: 站点名称、检测时间、状态(可用/不可用)、响应时间、HTTP状态码、详细错误信息(包括网络错误类型和服务器返回消息)
  - 关系: 每个Site可以有多个AvailabilityRecord

- **CheckResult**: 代表一次检测的结果
  - 属性: 目标站点、检测时间、成功状态、响应时长、错误描述

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在首页加载后1秒内看到站点可用性检测模块
- **SC-002**: 单个站点的可用性检测在10秒内完成(包含超时情况)
- **SC-003**: 系统支持同时检测至少20个站点而不影响页面响应性
- **SC-004**: 手动刷新操作的响应时间在500毫秒内启动检测流程
- **SC-005**: 检测结果显示的准确率达到95%以上(与实际站点状态一致)
- **SC-006**: 用户能在3秒内识别出哪些站点不可用(通过颜色和文字)
- **SC-007**: 每个站点的历史记录在浏览器localStorage中保留最近10-20次检测结果

## Assumptions

1. **检测标准**: 站点能成功响应最小API请求(如模型列表查询)即视为可用,使用站点配置的认证信息进行完整API链路验证
2. **API成本**: 检测请求可能产生少量API调用计费,用户接受此成本以换取真实可用性验证
3. **数据保留**: 历史记录保存在浏览器localStorage中,保留最近10-20条记录,用户清除浏览器缓存会导致历史数据丢失(这是可接受的tradeoff)
4. **刷新策略**: 首次加载首页时自动触发一次检测,后续仅由用户手动触发,不进行周期性自动刷新
5. **界面布局**: 模块在首页显著位置,便于用户快速查看
6. **性能优化**: 系统使用批次检测机制,限制并发数为5个,避免浏览器连接限制和资源耗尽问题
